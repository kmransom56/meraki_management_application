<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cisco Meraki Web Management - Comprehensive Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .feature-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-unknown { background-color: #ffc107; }
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .nav-link {
            color: white !important;
            border-radius: 8px;
            margin: 2px 0;
        }
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="text-center mb-4">
                    <h4 class="text-white"><i class="fas fa-network-wired"></i> Meraki Web</h4>
                    <small class="text-light">Comprehensive Management</small>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('network-status')">
                            <i class="fas fa-chart-line"></i> Network Status
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('devices')">
                            <i class="fas fa-server"></i> Devices
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('switches-aps')">
                            <i class="fas fa-wifi"></i> Switches & APs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('appliances')">
                            <i class="fas fa-shield-alt"></i> Appliances
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('environmental')">
                            <i class="fas fa-thermometer-half"></i> Environmental
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('topology')">
                            <i class="fas fa-project-diagram"></i> Network Topology
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('tools')">
                            <i class="fas fa-tools"></i> Swiss Army Knife
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('settings')">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <!-- API Key Setup Section -->
                <div id="api-setup" class="mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-key"></i> API Configuration</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="apiKey" class="form-label">Meraki API Key</label>
                                        <input type="password" class="form-control" id="apiKey" placeholder="Enter your Meraki API key">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="apiMode" class="form-label">API Mode</label>
                                        <select class="form-select" id="apiMode">
                                            <option value="custom">Custom API</option>
                                            <option value="sdk">Meraki SDK</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary d-block w-100" onclick="validateApiKey()">
                                            <i class="fas fa-check"></i> Validate Key
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="apiStatus" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Organization & Network Selection -->
                <div id="org-network-selection" class="mb-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-building"></i> Organization & Network Selection</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="organizationSelect" class="form-label">Organization</label>
                                        <select class="form-select" id="organizationSelect" onchange="loadNetworks()">
                                            <option value="">Select Organization...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="networkSelect" class="form-label">Network</label>
                                        <select class="form-select" id="networkSelect" onchange="loadNetworkData()">
                                            <option value="">Select Network...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                            <p class="text-muted">Comprehensive Cisco Meraki network management interface</p>
                        </div>
                    </div>

                    <!-- Quick Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalDevices">-</h4>
                                            <small>Total Devices</small>
                                        </div>
                                        <i class="fas fa-server fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="onlineDevices">-</h4>
                                            <small>Online Devices</small>
                                        </div>
                                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalClients">-</h4>
                                            <small>Active Clients</small>
                                        </div>
                                        <i class="fas fa-users fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="networkHealth">-</h4>
                                            <small>Network Health</small>
                                        </div>
                                        <i class="fas fa-heartbeat fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Cards -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('network-status')">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                                    <h5>Network Status</h5>
                                    <p class="text-muted">Monitor network performance and device status</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('devices')">
                                <div class="card-body text-center">
                                    <i class="fas fa-server fa-3x text-success mb-3"></i>
                                    <h5>Device Management</h5>
                                    <p class="text-muted">Manage switches, access points, and appliances</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('topology')">
                                <div class="card-body text-center">
                                    <i class="fas fa-project-diagram fa-3x text-info mb-3"></i>
                                    <h5>Network Topology</h5>
                                    <p class="text-muted">Interactive network visualization and mapping</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('environmental')">
                                <div class="card-body text-center">
                                    <i class="fas fa-thermometer-half fa-3x text-warning mb-3"></i>
                                    <h5>Environmental</h5>
                                    <p class="text-muted">Monitor temperature, power, and environmental sensors</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('tools')">
                                <div class="card-body text-center">
                                    <i class="fas fa-tools fa-3x text-secondary mb-3"></i>
                                    <h5>Swiss Army Knife</h5>
                                    <p class="text-muted">Utility tools: password gen, subnet calc, IP check</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('diagnostics')">
                                <div class="card-body text-center">
                                    <i class="fas fa-tachometer-alt fa-3x text-danger mb-3"></i>
                                    <h5>Network Diagnostics</h5>
                                    <p class="text-muted">Speed tests, throughput tests, and network analysis</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('settings')">
                                <div class="card-body text-center">
                                    <i class="fas fa-cog fa-3x text-dark mb-3"></i>
                                    <h5>Settings</h5>
                                    <p class="text-muted">API configuration, SSL testing, and preferences</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other sections will be loaded dynamically -->
                <div id="dynamic-content"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentApiKey = null;
        let currentOrganization = null;
        let currentNetwork = null;

        // Show/hide sections
        function showSection(sectionName) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Load section content
            loadSectionContent(sectionName);
        }
        
        // Load content for different sections
        function loadSectionContent(sectionName) {
            const dynamicContent = document.getElementById('dynamic-content');
            
            switch(sectionName) {
                case 'dashboard':
                    dynamicContent.innerHTML = '';
                    break;
                case 'network-status':
                    showNetworkStatusSection();
                    break;
                case 'devices':
                    showDevicesSection();
                    break;
                case 'topology':
                    showTopologySection();
                    break;
                case 'environmental':
                    showEnvironmentalSection();
                    break;
                case 'diagnostics':
                    showDiagnosticsSection();
                    break;
                case 'tools':
                    showToolsSection();
                    break;
                case 'settings':
                    showSettingsSection();
                    break;
                default:
                    dynamicContent.innerHTML = '<div class="alert alert-warning">Section not implemented yet.</div>';
            }
        }

        // Validate API key
        async function validateApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            const apiMode = document.getElementById('apiMode').value;
            
            if (!apiKey) {
                showAlert('Please enter an API key', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/validate_key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey,
                        api_mode: apiMode
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentApiKey = apiKey;
                    showAlert('API key validated successfully!', 'success');
                    document.getElementById('org-network-selection').style.display = 'block';
                    // Wait a moment for session to be established, then load organizations
                    setTimeout(() => {
                        loadOrganizations();
                    }, 500);
                } else {
                    showAlert('Invalid API key: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('Error validating API key: ' + error.message, 'danger');
            }
        }

        // Load organizations
        async function loadOrganizations() {
            try {
                const response = await fetch('/api/organizations');
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load organizations');
                }
                
                const select = document.getElementById('organizationSelect');
                select.innerHTML = '<option value="">Select Organization...</option>';
                
                // Handle both direct array and wrapped response
                const orgs = result.organizations || result || [];
                
                if (Array.isArray(orgs) && orgs.length > 0) {
                    orgs.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        select.appendChild(option);
                    });
                } else {
                    showAlert('No organizations found. Please check your API key.', 'warning');
                }
            } catch (error) {
                console.error('Organizations loading error:', error);
                showAlert('Error loading organizations: ' + error.message, 'danger');
            }
        }

        // Load networks for selected organization
        async function loadNetworks() {
            const orgId = document.getElementById('organizationSelect').value;
            if (!orgId) return;

            currentOrganization = orgId;
            
            try {
                const response = await fetch(`/api/networks/${orgId}`);
                const result = await response.json();
                
                const select = document.getElementById('networkSelect');
                select.innerHTML = '<option value="">Select Network...</option>';
                
                result.networks.forEach(network => {
                    const option = document.createElement('option');
                    option.value = network.id;
                    option.textContent = network.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Error loading networks: ' + error.message, 'danger');
            }
        }

        // Load network data and update dashboard
        async function loadNetworkData() {
            const networkId = document.getElementById('networkSelect').value;
            if (!networkId) return;

            currentNetwork = networkId;
            updateDashboardStats();
        }

        // Update dashboard statistics
        async function updateDashboardStats() {
            if (!currentNetwork) return;

            try {
                // Load devices
                const devicesResponse = await fetch(`/api/devices/${currentNetwork}`);
                const devicesResult = await devicesResponse.json();
                
                // Load clients
                const clientsResponse = await fetch(`/api/clients/${currentNetwork}`);
                const clientsResult = await clientsResponse.json();
                
                // Update stats
                const totalDevices = devicesResult.devices.length;
                const onlineDevices = devicesResult.devices.filter(d => d.status === 'online').length;
                const totalClients = clientsResult.clients.length;
                const healthPercentage = totalDevices > 0 ? Math.round((onlineDevices / totalDevices) * 100) : 0;
                
                document.getElementById('totalDevices').textContent = totalDevices;
                document.getElementById('onlineDevices').textContent = onlineDevices;
                document.getElementById('totalClients').textContent = totalClients;
                document.getElementById('networkHealth').textContent = healthPercentage + '%';
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Load section content dynamically
        function loadSectionContent(sectionName) {
            const dynamicContent = document.getElementById('dynamic-content');
            const dashboardSection = document.getElementById('dashboard-section');
            
            if (sectionName === 'dashboard') {
                dashboardSection.style.display = 'block';
                dynamicContent.innerHTML = '';
                return;
            }
            
            dashboardSection.style.display = 'none';
            
            // Load specific section content
            switch (sectionName) {
                case 'network-status':
                    loadNetworkStatusSection();
                    break;
                case 'devices':
                    loadDevicesSection();
                    break;
                case 'topology':
                    loadTopologySection();
                    break;
                case 'tools':
                    loadToolsSection();
                    break;
                case 'settings':
                    loadSettingsSection();
                    break;
                default:
                    dynamicContent.innerHTML = `<h3>Coming Soon: ${sectionName}</h3><p>This section is under development.</p>`;
            }
        }

        // Load specific sections (placeholder functions)
        function loadNetworkStatusSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-chart-line"></i> Network Status</h2>
                <div class="alert alert-info">Network status monitoring will be displayed here.</div>
            `;
        }

        function loadDevicesSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-server"></i> Device Management</h2>
                <div class="alert alert-info">Device management interface will be displayed here.</div>
            `;
        }

        function loadTopologySection() {
            if (!currentNetwork) {
                document.getElementById('dynamic-content').innerHTML = `
                    <h2><i class="fas fa-project-diagram"></i> Network Topology</h2>
                    <div class="alert alert-warning">Please select a network first.</div>
                `;
                return;
            }
            
            // Launch topology visualization
            window.open(`/visualization/${currentNetwork}`, '_blank');
        }

        function loadToolsSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-tools"></i> Swiss Army Knife Tools</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5><i class="fas fa-key"></i> Password Generator</h5>
                                <div class="mb-3">
                                    <label class="form-label">Length</label>
                                    <input type="number" class="form-control" id="passwordLength" value="12" min="4" max="64">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeSymbols" checked>
                                        <label class="form-check-label" for="includeSymbols">Include Symbols</label>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="generatePassword()">Generate Password</button>
                                <div id="generatedPassword" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5><i class="fas fa-calculator"></i> Subnet Calculator</h5>
                                <div class="mb-3">
                                    <label class="form-label">Network (CIDR)</label>
                                    <input type="text" class="form-control" id="subnetInput" placeholder="192.168.1.0/24">
                                </div>
                                <button class="btn btn-primary" onclick="calculateSubnet()">Calculate</button>
                                <div id="subnetResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadSettingsSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <div class="card">
                    <div class="card-body">
                        <h5>SSL Connection Test</h5>
                        <p>Test SSL connectivity for corporate environments</p>
                        <button class="btn btn-primary" onclick="testSSL()">Test SSL Connection</button>
                        <div id="sslTestResult" class="mt-3"></div>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.innerHTML = '';
            apiStatus.appendChild(alertDiv);
        }

        // Tool functions
        async function generatePassword() {
            const length = document.getElementById('passwordLength').value;
            const symbols = document.getElementById('includeSymbols').checked;
            
            try {
                const response = await fetch('/api/tools/password_generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ length: parseInt(length), symbols: symbols })
                });
                
                const result = await response.json();
                document.getElementById('generatedPassword').innerHTML = 
                    `<div class="alert alert-success"><strong>Generated Password:</strong> <code>${result.password}</code></div>`;
            } catch (error) {
                document.getElementById('generatedPassword').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function testSSL() {
            try {
                const response = await fetch('/api/test_ssl');
                const result = await response.json();
                
                const resultDiv = document.getElementById('sslTestResult');
                if (result.ssl_working) {
                    resultDiv.innerHTML = '<div class="alert alert-success">SSL connection working properly!</div>';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">SSL connection failed: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('sslTestResult').innerHTML = 
                    `<div class="alert alert-danger">Error testing SSL: ${error.message}</div>`;
            }
        }

        // Network Diagnostics Functions
        function showDiagnosticsSection() {
            const content = `
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2><i class="fas fa-tachometer-alt"></i> Network Diagnostics</h2>
                                <button class="btn btn-secondary" onclick="showSection('dashboard')">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Device Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-server"></i> Select Device for Testing</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="diagnosticsNetwork" class="form-label">Network:</label>
                                        <select class="form-select" id="diagnosticsNetwork" onchange="loadDiagnosticsDevices()">
                                            <option value="">Select a network...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="diagnosticsDevice" class="form-label">Device:</label>
                                        <select class="form-select" id="diagnosticsDevice">
                                            <option value="">Select a device...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-info-circle"></i> Test Information</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Speed Test:</strong> Measures download/upload speeds, latency, jitter, and packet loss.</p>
                                    <p><strong>Throughput Test:</strong> Measures maximum data transfer rate through the device.</p>
                                    <p class="text-muted"><small>Note: Tests may take 30-60 seconds to complete.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Tests -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-tachometer-alt"></i> Performance Tests</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <button class="btn btn-primary w-100" onclick="startSpeedTest()" id="speedTestBtn">
                                                <i class="fas fa-rocket"></i> Speed Test
                                            </button>
                                            <div id="speedTestResults" class="mt-2"></div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <button class="btn btn-success w-100" onclick="startThroughputTest()" id="throughputTestBtn">
                                                <i class="fas fa-chart-bar"></i> Throughput Test
                                            </button>
                                            <div id="throughputTestResults" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Analysis Tools -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-network-wired"></i> Network Analysis Tools</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <button class="btn btn-info w-100" onclick="startArpTableTest()" id="arpTableBtn">
                                                <i class="fas fa-table"></i> ARP Table
                                            </button>
                                            <div id="arpTableResults" class="mt-2"></div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <button class="btn btn-info w-100" onclick="startMacTableTest()" id="macTableBtn">
                                                <i class="fas fa-list"></i> MAC Table
                                            </button>
                                            <div id="macTableResults" class="mt-2"></div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <button class="btn btn-info w-100" onclick="startRoutingTableTest()" id="routingTableBtn">
                                                <i class="fas fa-route"></i> Routing Table
                                            </button>
                                            <div id="routingTableResults" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connectivity Tests -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-wifi"></i> Connectivity & Protocol Tests</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="pingTarget" placeholder="8.8.8.8" value="8.8.8.8">
                                                <button class="btn btn-warning" onclick="startPingTest()" id="pingBtn">
                                                    <i class="fas fa-satellite-dish"></i> Ping
                                                </button>
                                            </div>
                                            <div id="pingResults" class="mt-2"></div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <button class="btn btn-secondary w-100" onclick="startOspfNeighborsTest()" id="ospfBtn">
                                                <i class="fas fa-project-diagram"></i> OSPF Neighbors
                                            </button>
                                            <div id="ospfResults" class="mt-2"></div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <button class="btn btn-dark w-100" onclick="startDhcpLeasesTest()" id="dhcpBtn">
                                                <i class="fas fa-server"></i> DHCP Leases
                                            </button>
                                            <div id="dhcpResults" class="mt-2"></div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="cyclePorts" placeholder="1,2,3">
                                                <button class="btn btn-danger" onclick="startCyclePortTest()" id="cyclePortBtn">
                                                    <i class="fas fa-power-off"></i> Cycle Port
                                                </button>
                                            </div>
                                            <div id="cyclePortResults" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test History -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-history"></i> Test History</h5>
                                </div>
                                <div class="card-body">
                                    <div id="testHistory">
                                        <p class="text-muted">No tests performed yet.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('dynamic-content').innerHTML = content;
            loadDiagnosticsNetworks();
        }
        
        async function loadDiagnosticsNetworks() {
            if (!currentApiKey) {
                showAlert('Please set your API key first', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/organizations');
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load organizations');
                }
                
                // Handle both direct array and wrapped response
                const orgs = result.organizations || result || [];
                
                if (Array.isArray(orgs) && orgs.length > 0) {
                    // Load networks for first organization
                    const networksResponse = await fetch(`/api/networks/${orgs[0].id}`);
                    const networksResult = await networksResponse.json();
                    
                    if (!networksResponse.ok) {
                        throw new Error(networksResult.error || 'Failed to load networks');
                    }
                    
                    const networkSelect = document.getElementById('diagnosticsNetwork');
                    networkSelect.innerHTML = '<option value="">Select a network...</option>';
                    
                    // Handle both direct array and wrapped response
                    const networks = networksResult.networks || networksResult || [];
                    
                    if (Array.isArray(networks)) {
                        networks.forEach(network => {
                            const option = document.createElement('option');
                            option.value = network.id;
                            option.textContent = network.name;
                            networkSelect.appendChild(option);
                        });
                    }
                } else {
                    showAlert('No organizations found for diagnostics', 'warning');
                }
            } catch (error) {
                console.error('Diagnostics networks loading error:', error);
                showAlert('Error loading networks: ' + error.message, 'danger');
            }
        }
        
        async function loadDiagnosticsDevices() {
            const networkId = document.getElementById('diagnosticsNetwork').value;
            if (!networkId) return;
            
            try {
                const response = await fetch(`/api/devices/${networkId}`);
                const devices = await response.json();
                
                const deviceSelect = document.getElementById('diagnosticsDevice');
                deviceSelect.innerHTML = '<option value="">Select a device...</option>';
                
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.serial;
                    option.textContent = `${device.name || device.model} (${device.serial})`;
                    deviceSelect.appendChild(option);
                });
            } catch (error) {
                showAlert('Error loading devices: ' + error.message, 'danger');
            }
        }
        
        async function startSpeedTest() {
            const deviceSerial = document.getElementById('diagnosticsDevice').value;
            if (!deviceSerial) {
                showAlert('Please select a device first', 'warning');
                return;
            }
            
            const btn = document.getElementById('speedTestBtn');
            const resultsDiv = document.getElementById('speedTestResults');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting Speed Test...';
            resultsDiv.innerHTML = '<div class="alert alert-info">Initiating speed test...</div>';
            
            try {
                // Start speed test
                const response = await fetch(`/api/devices/${deviceSerial}/speed_test`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultsDiv.innerHTML = '<div class="alert alert-info">Speed test running... Please wait 30-60 seconds.</div>';
                    
                    // Poll for results
                    pollSpeedTestResults(deviceSerial, result.speed_test_id);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Speed Test';
            }
        }
        
        async function pollSpeedTestResults(deviceSerial, speedTestId) {
            const resultsDiv = document.getElementById('speedTestResults');
            let attempts = 0;
            const maxAttempts = 20; // 2 minutes max
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/devices/${deviceSerial}/speed_test/${speedTestId}`);
                    const result = await response.json();
                    
                    if (result.success && result.status === 'complete') {
                        displaySpeedTestResults(result);
                        addToTestHistory('Speed Test', result);
                    } else if (result.status === 'failed') {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">Speed test failed</div>';
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 6000); // Poll every 6 seconds
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-warning">Speed test timed out</div>';
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            };
            
            setTimeout(poll, 6000); // Start polling after 6 seconds
        }
        
        function displaySpeedTestResults(result) {
            const resultsDiv = document.getElementById('speedTestResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> Speed Test Complete</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Download:</strong> ${result.download_mbps || 'N/A'} Mbps<br>
                            <strong>Upload:</strong> ${result.upload_mbps || 'N/A'} Mbps
                        </div>
                        <div class="col-md-6">
                            <strong>Latency:</strong> ${result.latency_ms || 'N/A'} ms<br>
                            <strong>Jitter:</strong> ${result.jitter_ms || 'N/A'} ms<br>
                            <strong>Packet Loss:</strong> ${result.packet_loss_percent || 'N/A'}%
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function startThroughputTest() {
            const deviceSerial = document.getElementById('diagnosticsDevice').value;
            if (!deviceSerial) {
                showAlert('Please select a device first', 'warning');
                return;
            }
            
            const btn = document.getElementById('throughputTestBtn');
            const resultsDiv = document.getElementById('throughputTestResults');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting Throughput Test...';
            resultsDiv.innerHTML = '<div class="alert alert-info">Initiating throughput test...</div>';
            
            try {
                // Start throughput test
                const response = await fetch(`/api/devices/${deviceSerial}/throughput_test`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultsDiv.innerHTML = '<div class="alert alert-info">Throughput test running... Please wait 30-60 seconds.</div>';
                    
                    // Poll for results
                    pollThroughputTestResults(deviceSerial, result.throughput_test_id);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Throughput Test';
            }
        }
        
        async function pollThroughputTestResults(deviceSerial, throughputTestId) {
            const resultsDiv = document.getElementById('throughputTestResults');
            let attempts = 0;
            const maxAttempts = 20; // 2 minutes max
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/devices/${deviceSerial}/throughput_test/${throughputTestId}`);
                    const result = await response.json();
                    
                    if (result.success && result.status === 'complete') {
                        displayThroughputTestResults(result);
                        addToTestHistory('Throughput Test', result);
                    } else if (result.status === 'failed') {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">Throughput test failed</div>';
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 6000); // Poll every 6 seconds
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-warning">Throughput test timed out</div>';
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            };
            
            setTimeout(poll, 6000); // Start polling after 6 seconds
        }
        
        function displayThroughputTestResults(result) {
            const resultsDiv = document.getElementById('throughputTestResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> Throughput Test Complete</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Throughput:</strong> ${result.throughput_mbps || 'N/A'} Mbps
                        </div>
                        <div class="col-md-6">
                            <strong>Interface:</strong> ${result.interface || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addToTestHistory(testType, result) {
            const historyDiv = document.getElementById('testHistory');
            const timestamp = new Date().toLocaleString();
            
            if (historyDiv.innerHTML.includes('No tests performed yet')) {
                historyDiv.innerHTML = '';
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'border-bottom pb-2 mb-2';
            
            let resultSummary = '';
            switch(testType) {
                case 'Speed Test':
                    resultSummary = `Download: ${result.download_mbps || 'N/A'} Mbps, Upload: ${result.upload_mbps || 'N/A'} Mbps`;
                    break;
                case 'Throughput Test':
                    resultSummary = `Throughput: ${result.throughput_mbps || 'N/A'} Mbps`;
                    break;
                case 'Ping Test':
                    resultSummary = `Target: ${result.target || 'N/A'}, Loss: ${result.loss_percent || 'N/A'}%`;
                    break;
                case 'ARP Table':
                    resultSummary = `Entries: ${result.entries ? result.entries.length : 'N/A'}`;
                    break;
                case 'MAC Table':
                    resultSummary = `Entries: ${result.entries ? result.entries.length : 'N/A'}`;
                    break;
                case 'Routing Table':
                    resultSummary = `Routes: ${result.entries ? result.entries.length : 'N/A'}`;
                    break;
                case 'OSPF Neighbors':
                    resultSummary = `Neighbors: ${result.neighbors ? result.neighbors.length : 'N/A'}`;
                    break;
                case 'DHCP Leases':
                    resultSummary = `Leases: ${result.leases ? result.leases.length : 'N/A'}`;
                    break;
                case 'Cycle Port':
                    resultSummary = `Ports: ${result.ports ? result.ports.join(', ') : 'N/A'}`;
                    break;
                default:
                    resultSummary = 'Completed';
            }
            
            historyItem.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${testType}</strong>
                    <small class="text-muted">${timestamp}</small>
                </div>
                <div class="text-muted">${resultSummary}</div>
            `;
            
            historyDiv.insertBefore(historyItem, historyDiv.firstChild);
        }
        
        // Additional Live Tools Functions
        
        async function startArpTableTest() {
            const deviceSerial = document.getElementById('diagnosticsDevice').value;
            if (!deviceSerial) {
                showAlert('Please select a device first', 'warning');
                return;
            }
            
            const btn = document.getElementById('arpTableBtn');
            const resultsDiv = document.getElementById('arpTableResults');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            resultsDiv.innerHTML = '<div class="alert alert-info">Getting ARP table...</div>';
            
            try {
                const response = await fetch(`/api/devices/${deviceSerial}/arp_table`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    pollArpTableResults(deviceSerial, result.arp_table_id);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-table"></i> ARP Table';
            }
        }
        
        async function pollArpTableResults(deviceSerial, arpTableId) {
            const resultsDiv = document.getElementById('arpTableResults');
            let attempts = 0;
            const maxAttempts = 10;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/devices/${deviceSerial}/arp_table/${arpTableId}`);
                    const result = await response.json();
                    
                    if (result.success && result.status === 'complete') {
                        displayArpTableResults(result);
                        addToTestHistory('ARP Table', result);
                    } else if (result.status === 'failed') {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">ARP table test failed</div>';
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 3000);
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-warning">ARP table test timed out</div>';
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            };
            
            setTimeout(poll, 3000);
        }
        
        function displayArpTableResults(result) {
            const resultsDiv = document.getElementById('arpTableResults');
            const entries = result.entries || [];
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> ARP Table Retrieved</h6>
                    <small>Found ${entries.length} entries</small>
                </div>
            `;
        }
        
        async function startMacTableTest() {
            const deviceSerial = document.getElementById('diagnosticsDevice').value;
            if (!deviceSerial) {
                showAlert('Please select a device first', 'warning');
                return;
            }
            
            const btn = document.getElementById('macTableBtn');
            const resultsDiv = document.getElementById('macTableResults');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            resultsDiv.innerHTML = '<div class="alert alert-info">Getting MAC table...</div>';
            
            try {
                const response = await fetch(`/api/devices/${deviceSerial}/mac_table`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    pollMacTableResults(deviceSerial, result.mac_table_id);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-list"></i> MAC Table';
            }
        }
        
        async function pollMacTableResults(deviceSerial, macTableId) {
            const resultsDiv = document.getElementById('macTableResults');
            let attempts = 0;
            const maxAttempts = 10;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/devices/${deviceSerial}/mac_table/${macTableId}`);
                    const result = await response.json();
                    
                    if (result.success && result.status === 'complete') {
                        displayMacTableResults(result);
                        addToTestHistory('MAC Table', result);
                    } else if (result.status === 'failed') {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">MAC table test failed</div>';
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 3000);
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-warning">MAC table test timed out</div>';
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            };
            
            setTimeout(poll, 3000);
        }
        
        function displayMacTableResults(result) {
            const resultsDiv = document.getElementById('macTableResults');
            const entries = result.entries || [];
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> MAC Table Retrieved</h6>
                    <small>Found ${entries.length} entries</small>
                </div>
            `;
        }
        
        async function startPingTest() {
            const deviceSerial = document.getElementById('diagnosticsDevice').value;
            const target = document.getElementById('pingTarget').value || '8.8.8.8';
            
            if (!deviceSerial) {
                showAlert('Please select a device first', 'warning');
                return;
            }
            
            const btn = document.getElementById('pingBtn');
            const resultsDiv = document.getElementById('pingResults');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ping...';
            resultsDiv.innerHTML = '<div class="alert alert-info">Running ping test...</div>';
            
            try {
                const response = await fetch(`/api/devices/${deviceSerial}/ping`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target, count: 5 })
                });
                const result = await response.json();
                
                if (result.success) {
                    pollPingResults(deviceSerial, result.ping_id);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Ping';
            }
        }
        
        async function pollPingResults(deviceSerial, pingId) {
            const resultsDiv = document.getElementById('pingResults');
            let attempts = 0;
            const maxAttempts = 15;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/devices/${deviceSerial}/ping/${pingId}`);
                    const result = await response.json();
                    
                    if (result.success && result.status === 'complete') {
                        displayPingResults(result);
                        addToTestHistory('Ping Test', result);
                    } else if (result.status === 'failed') {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">Ping test failed</div>';
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 2000);
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-warning">Ping test timed out</div>';
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            };
            
            setTimeout(poll, 2000);
        }
        
        function displayPingResults(result) {
            const resultsDiv = document.getElementById('pingResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> Ping Complete</h6>
                    <small>Target: ${result.target || 'N/A'}<br>
                    Sent: ${result.sent || 'N/A'}, Received: ${result.received || 'N/A'}<br>
                    Loss: ${result.loss_percent || 'N/A'}%</small>
                </div>
            `;
        }
        
        // Add similar functions for other live tools (routing table, OSPF, DHCP, cycle port)
        async function startRoutingTableTest() {
            await runGenericLiveToolTest('routing_table', 'routingTableBtn', 'routingTableResults', 'Routing Table');
        }
        
        async function startOspfNeighborsTest() {
            await runGenericLiveToolTest('ospf_neighbors', 'ospfBtn', 'ospfResults', 'OSPF Neighbors');
        }
        
        async function startDhcpLeasesTest() {
            await runGenericLiveToolTest('dhcp_leases', 'dhcpBtn', 'dhcpResults', 'DHCP Leases');
        }
        
        async function startCyclePortTest() {
            const ports = document.getElementById('cyclePorts').value;
            if (!ports) {
                showAlert('Please enter port numbers (e.g., 1,2,3)', 'warning');
                return;
            }
            
            const deviceSerial = document.getElementById('diagnosticsDevice').value;
            if (!deviceSerial) {
                showAlert('Please select a device first', 'warning');
                return;
            }
            
            const btn = document.getElementById('cyclePortBtn');
            const resultsDiv = document.getElementById('cyclePortResults');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cycling...';
            resultsDiv.innerHTML = '<div class="alert alert-info">Cycling ports...</div>';
            
            try {
                const portArray = ports.split(',').map(p => p.trim());
                const response = await fetch(`/api/devices/${deviceSerial}/cycle_port`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ports: portArray })
                });
                const result = await response.json();
                
                if (result.success) {
                    resultsDiv.innerHTML = '<div class="alert alert-success">Port cycle initiated successfully</div>';
                    addToTestHistory('Cycle Port', { ports: portArray });
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-power-off"></i> Cycle Port';
            }
        }
        
        async function runGenericLiveToolTest(toolType, btnId, resultsId, displayName) {
            const deviceSerial = document.getElementById('diagnosticsDevice').value;
            if (!deviceSerial) {
                showAlert('Please select a device first', 'warning');
                return;
            }
            
            const btn = document.getElementById(btnId);
            const resultsDiv = document.getElementById(resultsId);
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            resultsDiv.innerHTML = `<div class="alert alert-info">Getting ${displayName.toLowerCase()}...</div>`;
            
            try {
                const response = await fetch(`/api/devices/${deviceSerial}/${toolType}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultsDiv.innerHTML = `<div class="alert alert-success">${displayName} test initiated successfully</div>`;
                    addToTestHistory(displayName, result);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = btn.innerHTML.replace('<i class="fas fa-spinner fa-spin"></i> Running...', btn.getAttribute('data-original-text') || displayName);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            showSection('dashboard');
        });
    </script>
</body>
</html>
