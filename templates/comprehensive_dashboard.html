<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cisco Meraki Web Management - Comprehensive Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .feature-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-unknown { background-color: #ffc107; }
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .nav-link {
            color: white !important;
            border-radius: 8px;
            margin: 2px 0;
        }
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="text-center mb-4">
                    <h4 class="text-white"><i class="fas fa-network-wired"></i> Meraki Web</h4>
                    <small class="text-light">Comprehensive Management</small>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('network-status')">
                            <i class="fas fa-chart-line"></i> Network Status
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('devices')">
                            <i class="fas fa-server"></i> Devices
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('switches-aps')">
                            <i class="fas fa-wifi"></i> Switches & APs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('appliances')">
                            <i class="fas fa-shield-alt"></i> Appliances
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('environmental')">
                            <i class="fas fa-thermometer-half"></i> Environmental
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('topology')">
                            <i class="fas fa-project-diagram"></i> Network Topology
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('tools')">
                            <i class="fas fa-tools"></i> Swiss Army Knife
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('settings')">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <!-- API Key Setup Section -->
                <div id="api-setup" class="mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-key"></i> API Configuration</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="apiKey" class="form-label">Meraki API Key</label>
                                        <input type="password" class="form-control" id="apiKey" placeholder="Enter your Meraki API key">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="apiMode" class="form-label">API Mode</label>
                                        <select class="form-select" id="apiMode">
                                            <option value="custom">Custom API</option>
                                            <option value="sdk">Meraki SDK</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary d-block w-100" onclick="validateApiKey()">
                                            <i class="fas fa-check"></i> Validate Key
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="apiStatus" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Organization & Network Selection -->
                <div id="org-network-selection" class="mb-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-building"></i> Organization & Network Selection</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="organizationSelect" class="form-label">Organization</label>
                                        <select class="form-select" id="organizationSelect" onchange="loadNetworks()">
                                            <option value="">Select Organization...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="networkSelect" class="form-label">Network</label>
                                        <select class="form-select" id="networkSelect" onchange="loadNetworkData()">
                                            <option value="">Select Network...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                            <p class="text-muted">Comprehensive Cisco Meraki network management interface</p>
                        </div>
                    </div>

                    <!-- Quick Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalDevices">-</h4>
                                            <small>Total Devices</small>
                                        </div>
                                        <i class="fas fa-server fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="onlineDevices">-</h4>
                                            <small>Online Devices</small>
                                        </div>
                                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalClients">-</h4>
                                            <small>Active Clients</small>
                                        </div>
                                        <i class="fas fa-users fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="networkHealth">-</h4>
                                            <small>Network Health</small>
                                        </div>
                                        <i class="fas fa-heartbeat fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Cards -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('network-status')">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                                    <h5>Network Status</h5>
                                    <p class="text-muted">Monitor network performance and device status</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('devices')">
                                <div class="card-body text-center">
                                    <i class="fas fa-server fa-3x text-success mb-3"></i>
                                    <h5>Device Management</h5>
                                    <p class="text-muted">Manage switches, access points, and appliances</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('topology')">
                                <div class="card-body text-center">
                                    <i class="fas fa-project-diagram fa-3x text-info mb-3"></i>
                                    <h5>Network Topology</h5>
                                    <p class="text-muted">Interactive network visualization and mapping</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('environmental')">
                                <div class="card-body text-center">
                                    <i class="fas fa-thermometer-half fa-3x text-warning mb-3"></i>
                                    <h5>Environmental</h5>
                                    <p class="text-muted">Monitor temperature, power, and environmental sensors</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('tools')">
                                <div class="card-body text-center">
                                    <i class="fas fa-tools fa-3x text-secondary mb-3"></i>
                                    <h5>Swiss Army Knife</h5>
                                    <p class="text-muted">Utility tools: password gen, subnet calc, IP check</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card feature-card h-100" onclick="showSection('settings')">
                                <div class="card-body text-center">
                                    <i class="fas fa-cog fa-3x text-dark mb-3"></i>
                                    <h5>Settings</h5>
                                    <p class="text-muted">API configuration, SSL testing, and preferences</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other sections will be loaded dynamically -->
                <div id="dynamic-content"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentApiKey = null;
        let currentOrganization = null;
        let currentNetwork = null;

        // Show/hide sections
        function showSection(sectionName) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // Load section content
            loadSectionContent(sectionName);
        }

        // Validate API key
        async function validateApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            const apiMode = document.getElementById('apiMode').value;
            
            if (!apiKey) {
                showAlert('Please enter an API key', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/validate_key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey,
                        api_mode: apiMode
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentApiKey = apiKey;
                    showAlert('API key validated successfully!', 'success');
                    document.getElementById('org-network-selection').style.display = 'block';
                    loadOrganizations();
                } else {
                    showAlert('Invalid API key: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('Error validating API key: ' + error.message, 'danger');
            }
        }

        // Load organizations
        async function loadOrganizations() {
            try {
                const response = await fetch('/api/organizations');
                const result = await response.json();
                
                const select = document.getElementById('organizationSelect');
                select.innerHTML = '<option value="">Select Organization...</option>';
                
                result.organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Error loading organizations: ' + error.message, 'danger');
            }
        }

        // Load networks for selected organization
        async function loadNetworks() {
            const orgId = document.getElementById('organizationSelect').value;
            if (!orgId) return;

            currentOrganization = orgId;
            
            try {
                const response = await fetch(`/api/networks/${orgId}`);
                const result = await response.json();
                
                const select = document.getElementById('networkSelect');
                select.innerHTML = '<option value="">Select Network...</option>';
                
                result.networks.forEach(network => {
                    const option = document.createElement('option');
                    option.value = network.id;
                    option.textContent = network.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Error loading networks: ' + error.message, 'danger');
            }
        }

        // Load network data and update dashboard
        async function loadNetworkData() {
            const networkId = document.getElementById('networkSelect').value;
            if (!networkId) return;

            currentNetwork = networkId;
            updateDashboardStats();
        }

        // Update dashboard statistics
        async function updateDashboardStats() {
            if (!currentNetwork) return;

            try {
                // Load devices
                const devicesResponse = await fetch(`/api/devices/${currentNetwork}`);
                const devicesResult = await devicesResponse.json();
                
                // Load clients
                const clientsResponse = await fetch(`/api/clients/${currentNetwork}`);
                const clientsResult = await clientsResponse.json();
                
                // Update stats
                const totalDevices = devicesResult.devices.length;
                const onlineDevices = devicesResult.devices.filter(d => d.status === 'online').length;
                const totalClients = clientsResult.clients.length;
                const healthPercentage = totalDevices > 0 ? Math.round((onlineDevices / totalDevices) * 100) : 0;
                
                document.getElementById('totalDevices').textContent = totalDevices;
                document.getElementById('onlineDevices').textContent = onlineDevices;
                document.getElementById('totalClients').textContent = totalClients;
                document.getElementById('networkHealth').textContent = healthPercentage + '%';
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Load section content dynamically
        function loadSectionContent(sectionName) {
            const dynamicContent = document.getElementById('dynamic-content');
            const dashboardSection = document.getElementById('dashboard-section');
            
            if (sectionName === 'dashboard') {
                dashboardSection.style.display = 'block';
                dynamicContent.innerHTML = '';
                return;
            }
            
            dashboardSection.style.display = 'none';
            
            // Load specific section content
            switch (sectionName) {
                case 'network-status':
                    loadNetworkStatusSection();
                    break;
                case 'devices':
                    loadDevicesSection();
                    break;
                case 'topology':
                    loadTopologySection();
                    break;
                case 'tools':
                    loadToolsSection();
                    break;
                case 'settings':
                    loadSettingsSection();
                    break;
                default:
                    dynamicContent.innerHTML = `<h3>Coming Soon: ${sectionName}</h3><p>This section is under development.</p>`;
            }
        }

        // Load specific sections (placeholder functions)
        function loadNetworkStatusSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-chart-line"></i> Network Status</h2>
                <div class="alert alert-info">Network status monitoring will be displayed here.</div>
            `;
        }

        function loadDevicesSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-server"></i> Device Management</h2>
                <div class="alert alert-info">Device management interface will be displayed here.</div>
            `;
        }

        function loadTopologySection() {
            if (!currentNetwork) {
                document.getElementById('dynamic-content').innerHTML = `
                    <h2><i class="fas fa-project-diagram"></i> Network Topology</h2>
                    <div class="alert alert-warning">Please select a network first.</div>
                `;
                return;
            }
            
            // Launch topology visualization
            window.open(`/visualization/${currentNetwork}`, '_blank');
        }

        function loadToolsSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-tools"></i> Swiss Army Knife Tools</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5><i class="fas fa-key"></i> Password Generator</h5>
                                <div class="mb-3">
                                    <label class="form-label">Length</label>
                                    <input type="number" class="form-control" id="passwordLength" value="12" min="4" max="64">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeSymbols" checked>
                                        <label class="form-check-label" for="includeSymbols">Include Symbols</label>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="generatePassword()">Generate Password</button>
                                <div id="generatedPassword" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5><i class="fas fa-calculator"></i> Subnet Calculator</h5>
                                <div class="mb-3">
                                    <label class="form-label">Network (CIDR)</label>
                                    <input type="text" class="form-control" id="subnetInput" placeholder="192.168.1.0/24">
                                </div>
                                <button class="btn btn-primary" onclick="calculateSubnet()">Calculate</button>
                                <div id="subnetResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadSettingsSection() {
            document.getElementById('dynamic-content').innerHTML = `
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <div class="card">
                    <div class="card-body">
                        <h5>SSL Connection Test</h5>
                        <p>Test SSL connectivity for corporate environments</p>
                        <button class="btn btn-primary" onclick="testSSL()">Test SSL Connection</button>
                        <div id="sslTestResult" class="mt-3"></div>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.innerHTML = '';
            apiStatus.appendChild(alertDiv);
        }

        // Tool functions
        async function generatePassword() {
            const length = document.getElementById('passwordLength').value;
            const symbols = document.getElementById('includeSymbols').checked;
            
            try {
                const response = await fetch('/api/tools/password_generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ length: parseInt(length), symbols: symbols })
                });
                
                const result = await response.json();
                document.getElementById('generatedPassword').innerHTML = 
                    `<div class="alert alert-success"><strong>Generated Password:</strong> <code>${result.password}</code></div>`;
            } catch (error) {
                document.getElementById('generatedPassword').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function testSSL() {
            try {
                const response = await fetch('/api/test_ssl');
                const result = await response.json();
                
                const resultDiv = document.getElementById('sslTestResult');
                if (result.ssl_working) {
                    resultDiv.innerHTML = '<div class="alert alert-success">SSL connection working properly!</div>';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">SSL connection failed: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('sslTestResult').innerHTML = 
                    `<div class="alert alert-danger">Error testing SSL: ${error.message}</div>`;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            showSection('dashboard');
        });
    </script>
</body>
</html>
