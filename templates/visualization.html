<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Network Topology - {{ network_name }}</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- d3.js visualization library for network topology -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Using d3.js for interactive network visualization -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Lato font family like FortiGate -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* FortiGate-inspired color scheme */
            --fortinet-red: #d43527;
            --fortinet-dark-red: #b02e20;
            --fortinet-gray: #f5f5f5;
            --fortinet-dark-gray: #333333;
            --fortinet-light-gray: #e8e8e8;
            --fortinet-blue: #0066cc;
            --fortinet-green: #28a745;
            --fortinet-orange: #fd7e14;
            --background-level0: 248, 249, 250;
            --background-level1: 255, 255, 255;
            --background-level2: 245, 245, 245;
            --text-primary: 51, 51, 51;
            --text-secondary: 102, 102, 102;
        }

        * {
            scrollbar-width: auto;
            scrollbar-color: rgb(var(--background-level2)) rgba(0,0,0,0);
        }

        *::-webkit-scrollbar {
            background-color: transparent;
            width: 15px;
        }

        *::-webkit-scrollbar-thumb {
            min-height: 30px;
            border: 3px solid rgba(0,0,0,0);
            background-clip: padding-box;
            border-radius: 7px;
            background-color: rgb(var(--background-level2));
        }

        *::-webkit-scrollbar-button {
            width: 0;
            height: 0;
            display: none;
        }

        *::-webkit-scrollbar-corner {
            background-color: transparent;
        }

        body {
            margin: 0;
            font-family: 'Lato', Helvetica, Arial, sans-serif;
            font-weight: 400;
            background-color: rgb(var(--background-level0));
            color: rgb(var(--text-primary));
            font-size: 15px;
            overflow: hidden;
        }

        .header {
            background: rgb(var(--background-level1));
            border-bottom: 1px solid rgb(var(--background-level2));
            padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            position: relative;
            min-height: 60px;
        }

        .header h1 {
            margin: 0;
            color: var(--fortinet-red);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            color: var(--fortinet-red);
            font-size: 1.3rem;
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 400;
            color: rgb(var(--text-primary));
            white-space: nowrap;
            font-size: 14px;
        }

        .form-control-sm {
            border-radius: 4px;
            border: 1px solid rgb(var(--background-level2));
            padding: 6px 12px;
            font-size: 14px;
            font-family: 'Lato', sans-serif;
            background: rgb(var(--background-level1));
            color: rgb(var(--text-primary));
        }

        .form-control-sm:focus {
            border-color: var(--fortinet-blue);
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
            outline: none;
        }

        .btn-sm {
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 400;
            font-family: 'Lato', sans-serif;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .btn-fortinet {
            background: var(--fortinet-red);
            border-color: var(--fortinet-red);
            color: white;
        }

        .btn-fortinet:hover {
            background: var(--fortinet-dark-red);
            border-color: var(--fortinet-dark-red);
            color: white;
        }

        .btn-outline-secondary {
            background: transparent;
            border-color: rgb(var(--background-level2));
            color: rgb(var(--text-secondary));
        }

        .btn-outline-secondary:hover {
            background: rgb(var(--background-level2));
            border-color: rgb(var(--background-level2));
            color: rgb(var(--text-primary));
        }

        .stats-panel {
            position: fixed;
            right: 0;
            top: 77px;
            width: 300px;
            background: rgb(var(--background-level1));
            border-left: 1px solid rgb(var(--background-level2));
            padding: 24px;
            box-shadow: -1px 0 3px rgba(0, 0, 0, 0.05);
            height: calc(100vh - 77px);
            overflow-y: auto;
            z-index: 999;
        }

        .stats-panel h3 {
            margin-top: 0;
            color: var(--fortinet-red);
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 1px solid rgb(var(--background-level2));
            padding-bottom: 12px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgb(var(--background-level1));
            border: 1px solid rgb(var(--background-level2));
            padding: 16px;
            margin: 12px 0;
            border-radius: 4px;
            text-align: center;
            transition: box-shadow 0.2s ease;
        }

        .stat-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--fortinet-red);
            font-family: 'Lato', sans-serif;
        }

        .stat-label {
            color: rgb(var(--text-secondary));
            font-size: 14px;
            margin-top: 6px;
            font-weight: 400;
        }

        .legend {
            margin-top: 24px;
        }

        .legend h4 {
            color: var(--fortinet-red);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
            border-bottom: 1px solid rgb(var(--background-level2));
            padding-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px 12px;
            background: rgb(var(--background-level1));
            border: 1px solid rgb(var(--background-level2));
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .legend-item:hover {
            background: rgb(var(--background-level2));
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .legend-text {
            font-size: 14px;
            color: rgb(var(--text-primary));
            font-weight: 400;
        }

        #topology {
            width: calc(100vw - 280px);
            height: calc(100vh - 80px);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }

        .tooltip {
            position: absolute;
            background: rgba(51, 51, 51, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Lato', sans-serif;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            pointer-events: none;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tooltip-header {
            font-weight: 700;
            color: var(--fortinet-red);
            font-size: 14px;
            margin-bottom: 12px;
            border-bottom: 1px solid rgb(var(--background-level2));
            padding-bottom: 8px;
        }

        .tooltip-section {
            margin-bottom: 10px;
        }

        .tooltip-label {
            font-weight: 600;
            color: rgb(var(--text-secondary));
            font-size: 12px;
            margin-bottom: 2px;
        }

        .tooltip-value {
            color: rgb(var(--text-primary));
            font-size: 13px;
            margin-bottom: 6px;
        }

        .vlan-info {
            background: rgb(var(--background-level2));
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .vlan-item {
            font-size: 12px;
            margin: 2px 0;
            color: rgb(var(--text-primary));
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            stroke-width: 3px;
        }

        .node-label {
            font-size: 11px;
            font-weight: 500;
            text-anchor: middle;
            pointer-events: none;
            fill: rgb(var(--text-primary));
        }

        .link-label {
            font-size: 10px;
            font-weight: 500;
            text-anchor: middle;
            pointer-events: none;
            fill: rgb(var(--text-secondary));
            font-family: 'Lato', sans-serif;
        }

        .link-label-bg {
            fill: rgba(255, 255, 255, 0.9);
            stroke: rgb(var(--background-level2));
            stroke-width: 0.5;
            rx: 3;
            ry: 3;
        }

        .link {
            stroke-opacity: 0.8;
            stroke-width: 2px;
            transition: stroke-width 0.3s ease;
        }

        .link:hover {
            stroke-opacity: 1;
            stroke-width: 3px;
        }

        .hidden {
            opacity: 0.2;
        }

        .search-box {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1002;
            display: none;
        }

        .search-result {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-result:hover {
            background: #f8f9fa;
        }

        .search-result:last-child {
            border-bottom: none;
        }

        /* Device Inventory Table Styles */
        .view-tabs {
            display: flex;
            border-bottom: 1px solid rgb(var(--background-level2));
            margin-bottom: 20px;
            background: rgb(var(--background-level1));
        }

        .view-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: rgb(var(--text-secondary));
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-tab.active {
            color: var(--fortinet-red);
            border-bottom-color: var(--fortinet-red);
            font-weight: 500;
        }

        .view-tab:hover {
            color: rgb(var(--text-primary));
            background: rgba(var(--background-level2), 0.3);
        }

        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        .device-inventory-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Lato', sans-serif;
            font-size: 13px;
            background: rgb(var(--background-level1));
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .device-inventory-table thead {
            background: rgb(var(--background-level2));
        }

        .device-inventory-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 500;
            color: rgb(var(--text-primary));
            border-bottom: 1px solid rgb(var(--background-level2));
            white-space: nowrap;
        }

        .device-inventory-table td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(var(--background-level2), 0.5);
            color: rgb(var(--text-primary));
            vertical-align: middle;
        }

        .device-inventory-table tbody tr:hover {
            background: rgba(var(--background-level2), 0.3);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online {
            background: var(--fortinet-green);
        }

        .status-offline {
            background: #dc3545;
        }

        .status-warning {
            background: var(--fortinet-orange);
        }

        .device-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .device-fortigate {
            background: rgba(212, 53, 39, 0.1);
            color: var(--fortinet-red);
        }

        .device-switch {
            background: rgba(40, 167, 69, 0.1);
            color: var(--fortinet-green);
        }

        .device-wireless {
            background: rgba(253, 126, 20, 0.1);
            color: var(--fortinet-orange);
        }

        .device-appliance {
            background: rgba(0, 102, 204, 0.1);
            color: var(--fortinet-blue);
        }

        .device-client {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .device-unknown {
            background: rgba(158, 158, 158, 0.1);
            color: #9e9e9e;
        }

        .vlan-badge {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(0, 102, 204, 0.1);
            color: var(--fortinet-blue);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid rgb(var(--background-level2));
            border-radius: 6px;
        }

        .table-search {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .table-search input {
            flex: 1;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-network-wired"></i> Network Topology - {{ network_name }}</h1>
        <div class="controls">
            <div class="control-group">
                <label>Search:</label>
                <div class="search-box">
                    <input type="text" id="search" class="form-control form-control-sm" 
                           placeholder="Search devices..." style="width: 150px;">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter:</label>
                <select id="deviceFilter" class="form-control form-control-sm">
                    <option value="all">All Devices</option>
                    <optgroup label="QSR Equipment">
                        <option value="digital_menu">Digital Menu Boards</option>
                        <option value="kitchen_display">Kitchen Display Systems</option>
                        <option value="kitchen_timer">Kitchen Timers</option>
                        <option value="drive_thru_timer">Drive-Thru Timers</option>
                        <option value="pos_register">POS Registers</option>
                        <option value="pos_tablet">POS Tablets</option>
                        <option value="printer">Receipt Printers</option>
                    </optgroup>
                    <optgroup label="Network Infrastructure">
                        <option value="security_appliance">Security Appliances</option>
                        <option value="network_switch">Network Switches</option>
                        <option value="wifi_access_point">WiFi Access Points</option>
                        <option value="security_camera">Security Cameras</option>
                    </optgroup>
                    <optgroup label="Generic Types">
                        <option value="client">Client Devices</option>
                        <option value="unknown">Unknown Devices</option>
                    </optgroup>
                </select>
            </div>
            <div class="control-group">
                <label>Layout:</label>
                <select id="layoutType" class="form-control form-control-sm">
                    <option value="force">Force Directed</option>
                    <option value="radial">Radial</option>
                    <option value="hierarchical">Hierarchical</option>
                </select>
            </div>
            <button class="btn btn-fortinet btn-sm" onclick="resetView()">
                <i class="fas fa-home"></i> Reset View
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="window.close()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <div class="stats-panel">
        <h3><i class="fas fa-chart-bar"></i> Network Statistics</h3>
        
        <div class="stat-item">
            <div class="stat-number" id="deviceCount">{{ stats.devices }}</div>
            <div class="stat-label">Total Devices</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-number" id="clientCount">{{ stats.clients }}</div>
            <div class="stat-label">Connected Clients</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-number" id="nodeCount">{{ stats.nodes }}</div>
            <div class="stat-label">Topology Nodes</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-number" id="edgeCount">{{ stats.edges }}</div>
            <div class="stat-label">Connections</div>
        </div>

        <div class="legend">
            <h4>Device Types</h4>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2c3e50;"></div>
                <span class="legend-text">Internet/Gateway</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span class="legend-text">Fortigate Firewall</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #1f5582;"></div>
                <span class="legend-text">Meraki MX</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #28a745;"></div>
                <span class="legend-text">Meraki Switch</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fd7e14;"></div>
                <span class="legend-text">Meraki AP</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f39c12;"></div>
                <span class="legend-text">FortiAP</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #6c757d;"></div>
                <span class="legend-text">Client Device</span>
            </div>
        </div>

        <div class="legend">
            <h4>Connection Types</h4>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #00C853;"></div>
                <span class="legend-text">Uplink</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2196F3;"></div>
                <span class="legend-text">Switch Connection</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF9800;"></div>
                <span class="legend-text">Wireless</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #607D8B;"></div>
                <span class="legend-text">Wired Client</span>
            </div>
        </div>
    </div>

    <!-- Tabbed Interface for Topology and Device Inventory -->
    <div class="view-tabs">
        <button class="view-tab active" onclick="switchView('topology')">
            <i class="fas fa-project-diagram"></i> Network Topology
        </button>
        <button class="view-tab" onclick="switchView('inventory')">
            <i class="fas fa-list"></i> Device Inventory
        </button>
    </div>

    <!-- Network Topology View -->
    <div id="topology-view" class="view-content active">
        <div id="topology"></div>
    </div>

    <!-- Device Inventory Table View -->
    <div id="inventory-view" class="view-content">
        <div class="table-search">
            <input type="text" id="inventorySearch" class="form-control form-control-sm" 
                   placeholder="Search devices..." onkeyup="filterInventoryTable()">
            <select id="inventoryFilter" class="form-control form-control-sm" onchange="filterInventoryTable()">
                <option value="all">All Devices</option>
                <option value="fortigate">FortiGate</option>
                <option value="switch">Switches</option>
                <option value="fortiap">FortiAP</option>
                <option value="client">Clients</option>
            </select>
        </div>
        
        <div class="table-container">
            <table class="device-inventory-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Description</th>
                        <th>Last Seen (UTC)</th>
                        <th>Device Type</th>
                        <th>MAC Address</th>
                        <th>IPv4 Address</th>
                        <th>Connected To</th>
                        <th>VLAN</th>
                        <th>Vendor</th>
                        <th>Model</th>
                        <th>Firmware</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Device inventory rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        let currentLayout = 'force';
        let simulation;
        let svg;
        let link;
        let node;
        let nodeLabels;
        let linkLabels;
        let allNodes = [];
        let allLinks = [];
        let filteredNodes = [];
        let filteredLinks = [];

        // Color schemes for different device types
        const deviceColors = {
            'internet': '#2c3e50',       // Internet/Gateway - Dark Blue
            'appliance': '#1f5582',      // Meraki MX - Blue
            'switch': '#28a745',         // Meraki MS - Green  
            'wireless': '#fd7e14',       // Meraki MR - Orange
            'fortigate': '#e74c3c',      // Fortigate - Red
            'fortiap': '#f39c12',        // FortiAP - Yellow/Orange
            'client': '#6c757d',         // Clients - Gray
            'unknown': '#9e9e9e'         // Unknown - Light Gray
        };

        // Device icons using Font Awesome classes
        const deviceIcons = {
            'internet': 'fas fa-globe',           // Internet/Gateway - Globe
            'appliance': 'fas fa-shield-alt',     // Meraki MX - Shield
            'switch': 'fas fa-network-wired',     // Meraki MS - Network
            'wireless': 'fas fa-wifi',            // Meraki MR - WiFi
            'fortigate': 'fas fa-fire-alt',       // FortiGate - Fire/Security
            'fortiap': 'fas fa-broadcast-tower',  // FortiAP - Tower
            'client': 'fas fa-laptop',            // Clients - Laptop
            'unknown': 'fas fa-question-circle'   // Unknown - Question
        };

        const connectionColors = {
            'uplink': '#00C853',
            'switch': '#2196F3',
            'wireless': '#FF9800',
            'wired': '#607D8B',
            'unknown': '#9E9E9E'
        };

        // Function to get Font Awesome icon text for device types
        function getDeviceIconText(deviceType) {
            const iconMap = {
                'internet': '\uf0ac',      // fa-globe
                'appliance': '\uf3ed',     // fa-shield-alt
                'switch': '\uf6ff',        // fa-network-wired
                'wireless': '\uf1eb',      // fa-wifi
                'fortigate': '\uf6df',     // fa-fire-alt
                'fortiap': '\uf519',       // fa-broadcast-tower
                'client': '\uf109',        // fa-laptop
                'unknown': '\uf059'        // fa-question-circle
            };
            return iconMap[deviceType] || iconMap['unknown'];
        }

        // Load topology data with authentication handling
        function loadTopologyData() {
            var networkId = '{{ network_id }}';
            // Try multi-vendor endpoint first, fallback to regular endpoint
            var apiUrl = networkId ? '/api/visualization/' + networkId + '/multi-vendor/data' : '/api/visualization/data';
            
            console.log('Loading topology data from:', apiUrl);
            
            fetch(apiUrl)
                .then(response => {
                    if (response.status === 401) {
                        // API key not set - show authentication modal
                        showApiKeyModal();
                        return null;
                    }
                    if (!response.ok && response.status === 503) {
                        // FortiGate integration not available, try regular endpoint
                        return fetch('/api/visualization/' + networkId + '/data');
                    }
                    return response;
                })
                .then(response => {
                    if (!response) return; // Authentication modal shown
                    
                    if (response.status === 401) {
                        // Still no API key after fallback
                        showApiKeyModal();
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Authentication modal shown
                    
                    console.log('✅ Received topology data:', data);
                    
                    if (data.error) {
                        if (data.error.includes('API key')) {
                            showApiKeyModal();
                            return;
                        }
                        throw new Error(data.error);
                    }
                
                    allNodes = data.nodes || [];
                    allLinks = data.edges || [];
                    
                    console.log(`Loaded ${allNodes.length} nodes and ${allLinks.length} edges`);
                    
                    if (allNodes.length === 0) {
                        document.getElementById('topology').innerHTML = 
                            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 1.2rem;">' +
                            '<div style="text-align: center;"><i class="fas fa-info-circle"></i><br><br>No devices found in this network.<br><small>Make sure you have selected a network with devices.</small></div></div>';
                        return;
                    }
                    
                    initializeVisualization();
                })
                .catch(error => {
                    console.error('Error loading topology data:', error);
                    if (error.message.includes('API key') || error.message.includes('401')) {
                        showApiKeyModal();
                    } else {
                        document.getElementById('topology').innerHTML = 
                            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 1.2rem;">' +
                            '<div style="text-align: center;"><i class="fas fa-exclamation-triangle"></i><br><br>Error loading topology data<br><small>' + error.message + '</small></div></div>';
                    }
                });
        }
        
        // API Key Modal for Authentication
        function showApiKeyModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center;
                justify-content: center; z-index: 2000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 2rem; border-radius: 8px;
                max-width: 500px; width: 90%;
            `;
            
            content.innerHTML = `
                <h3 style="color: var(--fortinet-red); margin-bottom: 1rem;">
                    <i class="fas fa-key"></i> API Key Required
                </h3>
                <p style="margin-bottom: 1.5rem; color: #666;">
                    To view network topology data, please enter your Meraki Dashboard API key:
                </p>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Key:</label>
                    <input type="password" id="modalApiKey" placeholder="Enter your Meraki API key" 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeApiKeyModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="validateApiKeyFromModal()" style="padding: 0.5rem 1rem; background: var(--fortinet-red); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-check"></i> Validate & Load
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('modalApiKey').focus();
            }, 100);
            
            // Allow Enter key to submit
            document.getElementById('modalApiKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    validateApiKeyFromModal();
                }
            });
        }
        
        function closeApiKeyModal() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }
        
        function validateApiKeyFromModal() {
            const apiKey = document.getElementById('modalApiKey').value.trim();
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
            btn.disabled = true;
            
            // Validate API key
            fetch('/api/validate_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_key: apiKey,
                    api_mode: 'custom'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // API key validated, close modal and reload topology
                    closeApiKeyModal();
                    setTimeout(() => loadTopologyData(), 500);
                } else {
                    alert('Invalid API key: ' + (data.error || 'Please check your key and try again'));
                }
            })
            .catch(error => {
                console.error('API key validation error:', error);
                alert('Error validating API key. Please try again.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function initializeVisualization() {
            const width = window.innerWidth - 280;
            const height = window.innerHeight - 80;

            svg = d3.select('#topology')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(d3.zoom().on('zoom', function(event) {
                    svg.select('g').attr('transform', event.transform);
                }));

            const g = svg.append('g');

            // Initialize with all data
            filteredNodes = [...allNodes];
            filteredLinks = [...allLinks];

            // Create links - improved visibility with thicker lines
            link = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(filteredLinks)
                .enter().append('line')
                .attr('class', 'link')
                .attr('stroke', d => connectionColors[d.type] || connectionColors.unknown)
                .attr('stroke-width', d => d.width || 4)
                .attr('stroke-opacity', 0.8)
                .attr('stroke-dasharray', d => d.dashes ? '8,4' : null);

            // Create nodes with Font Awesome icons
            node = g.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(filteredNodes)
                .enter().append('g')
                .attr('class', 'node')
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', highlightNode)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add circles as background for icons - increased size for better visibility
            console.log('🎯 ENHANCED UI: Applying 30px device icon radius (was 20px)');
            node.append('circle')
                .attr('r', d => d.size || 30)
                .attr('fill', d => deviceColors[d.group] || deviceColors.unknown)
                .attr('stroke', '#fff')
                .attr('stroke-width', 3);

            // Add Font Awesome icons - increased size for better visibility
            node.append('text')
                .attr('class', 'device-icon')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'central')
                .attr('font-family', 'Font Awesome 6 Free')
                .attr('font-weight', '900')
                .attr('font-size', d => (d.size || 30) * 0.75)
                .attr('fill', '#fff')
                .text(d => getDeviceIconText(d.group));

            // Create node labels
            nodeLabels = g.append('g')
                .attr('class', 'node-labels')
                .selectAll('text')
                .data(filteredNodes)
                .enter().append('text')
                .attr('class', 'node-label')
                .text(d => d.label)
                .attr('dy', d => (d.size || 30) + 25);

            // Create VLAN connection labels
            linkLabels = g.append('g')
                .attr('class', 'link-labels')
                .selectAll('text')
                .data(filteredLinks.filter(d => d.vlan || d.vlanName))
                .enter().append('text')
                .attr('class', 'link-label')
                .text(d => d.vlanName || `VLAN ${d.vlan}` || d.type)
                .attr('font-size', '11px')
                .attr('fill', 'rgb(var(--text-secondary))')
                .attr('text-anchor', 'middle')
                .attr('pointer-events', 'none')
                .style('background', 'rgba(255, 255, 255, 0.8)')
                .style('padding', '2px 4px')
                .style('border-radius', '3px');

            // Initialize force simulation
            updateSimulation();

            // Set up event listeners
            setupEventListeners();
        }

        function updateSimulation() {
            const width = window.innerWidth - 280;
            const height = window.innerHeight - 80;

            if (simulation) {
                simulation.stop();
            }

            if (currentLayout === 'force') {
                simulation = d3.forceSimulation(filteredNodes)
                    .force('link', d3.forceLink(filteredLinks).id(d => d.id).distance(100))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(d => (d.size || 30) + 8));
            } else if (currentLayout === 'radial') {
                // Find central nodes (appliances/switches)
                const centralNodes = filteredNodes.filter(d => 
                    d.group === 'appliance' || d.group === 'switch');
                
                simulation = d3.forceSimulation(filteredNodes)
                    .force('link', d3.forceLink(filteredLinks).id(d => d.id).distance(80))
                    .force('charge', d3.forceManyBody().strength(-200))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('radial', d3.forceRadial(d => {
                        if (d.group === 'appliance') return 50;
                        if (d.group === 'switch') return 120;
                        if (d.group === 'wireless') return 180;
                        return 250;
                    }, width / 2, height / 2));
            } else if (currentLayout === 'hierarchical') {
                // Detect site type based on device composition
                const siteType = detectSiteType(filteredNodes);
                
                simulation = d3.forceSimulation(filteredNodes)
                    .force('link', d3.forceLink(filteredLinks).id(d => d.id).distance(120))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('y', d3.forceY(d => {
                        return getSiteSpecificYPosition(d, siteType, height);
                    }).strength(0.5))
                    .force('x', d3.forceX(width / 2).strength(0.1));
            }

            simulation.on('tick', ticked);
        }

        // Detect site type based on device composition
        function detectSiteType(nodes) {
            const hasFortiSwitch = nodes.some(node => 
                node.group === 'switch' && 
                (node.vendor?.toLowerCase().includes('fortinet') || 
                 node.label?.toLowerCase().includes('fortiswitch') ||
                 node.model?.toLowerCase().includes('fortiswitch'))
            );
            
            const hasMerakiSwitch = nodes.some(node => 
                node.group === 'switch' && 
                (node.vendor?.toLowerCase().includes('meraki') || 
                 node.vendor?.toLowerCase().includes('cisco') ||
                 node.label?.toLowerCase().includes('meraki') ||
                 node.model?.toLowerCase().includes('ms'))
            );
            
            let siteType;
            // Determine site type based on switch infrastructure
            if (hasFortiSwitch && !hasMerakiSwitch) {
                siteType = 'sonic'; // Sonic uses FortiSwitch
            } else if (hasMerakiSwitch && !hasFortiSwitch) {
                siteType = 'arbys_bww'; // Arby's and BWW use Meraki switches
            } else {
                // Default to Arby's/BWW layout if mixed or unclear
                siteType = 'arbys_bww';
            }
            
            // Update site layout indicator
            updateSiteLayoutIndicator(siteType);
            
            return siteType;
        }
        
        // Update site layout indicator
        function updateSiteLayoutIndicator(siteType) {
            const layoutInfo = document.querySelector('.layout-info');
            if (layoutInfo) {
                const siteNames = {
                    'sonic': 'Sonic (FortiSwitch)',
                    'arbys_bww': 'Arby\'s/BWW (Meraki Switch)'
                };
                layoutInfo.textContent = `Site Layout: ${siteNames[siteType]}`;
            }
        }

        // Get site-specific Y position for hierarchical layout
        function getSiteSpecificYPosition(device, siteType, height) {
            const deviceGroup = device.group;
            const deviceLabel = device.label?.toLowerCase() || '';
            const deviceVendor = device.vendor?.toLowerCase() || '';
            const deviceModel = device.model?.toLowerCase() || '';
            
            // Internet/Gateway at top for all sites
            if (deviceGroup === 'internet' || deviceLabel.includes('internet') || deviceLabel.includes('gateway')) {
                return height * 0.1;
            }
            
            // FortiGate firewalls - second level for all sites
            if (deviceGroup === 'fortigate' || deviceLabel.includes('fortigate')) {
                return height * 0.25;
            }
            
            if (siteType === 'sonic') {
                // Sonic Layout: Internet → FortiGate → FortiSwitch → FortiAP/End Device
                
                // FortiSwitch - third level
                if (deviceGroup === 'switch' && 
                    (deviceVendor.includes('fortinet') || deviceLabel.includes('fortiswitch') || deviceModel.includes('fortiswitch'))) {
                    return height * 0.45;
                }
                
                // FortiAP - fourth level
                if (deviceGroup === 'fortiap' || deviceGroup === 'wireless' || deviceLabel.includes('fortiap')) {
                    return height * 0.65;
                }
                
                // End devices - fifth level
                if (deviceGroup === 'client' || deviceGroup === 'unknown') {
                    return height * 0.85;
                }
                
                // Any other switch types (fallback)
                if (deviceGroup === 'switch' || deviceGroup === 'appliance') {
                    return height * 0.45;
                }
                
            } else {
                // Arby's/BWW Layout: Internet → FortiGate → Meraki Switch → FortiAP/End Device
                
                // Meraki Switch - third level
                if (deviceGroup === 'switch' || deviceGroup === 'appliance') {
                    return height * 0.45;
                }
                
                // FortiAP and wireless access points - fourth level
                if (deviceGroup === 'fortiap' || deviceGroup === 'wireless' || deviceLabel.includes('fortiap')) {
                    return height * 0.65;
                }
                
                // End devices - fifth level
                if (deviceGroup === 'client' || deviceGroup === 'unknown') {
                    return height * 0.85;
                }
            }
            
            // Default positioning for unclassified devices
            return height * 0.85;
        }

        function ticked() {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node
                .attr('transform', d => `translate(${d.x},${d.y})`);

            nodeLabels
                .attr('x', d => d.x)
                .attr('y', d => d.y);

            // Position VLAN connection labels at the center of links
            if (linkLabels) {
                linkLabels
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2 - 5);
            }
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            
            // Create detailed device information like FortiGate device inventory
            let tooltipContent = `
                <div class="tooltip-header">
                    <i class="${deviceIcons[d.group] || deviceIcons.unknown}"></i>
                    ${d.label || d.name || 'Unknown Device'}
                </div>
                
                <div class="tooltip-section">
                    <div class="tooltip-label">Device Type:</div>
                    <div class="tooltip-value">${getDeviceTypeName(d.group)}</div>
                </div>
                
                <div class="tooltip-section">
                    <div class="tooltip-label">Status:</div>
                    <div class="tooltip-value" style="color: ${d.status === 'online' ? 'var(--fortinet-green)' : 'var(--fortinet-red)'}">
                        <i class="fas fa-circle" style="font-size: 8px; margin-right: 4px;"></i>
                        ${d.status || 'Unknown'}
                    </div>
                </div>
                
                <div class="tooltip-section">
                    <div class="tooltip-label">IP Address:</div>
                    <div class="tooltip-value">${d.ip || d.address || 'N/A'}</div>
                </div>
                
                <div class="tooltip-section">
                    <div class="tooltip-label">MAC Address:</div>
                    <div class="tooltip-value">${d.mac || 'N/A'}</div>
                </div>
                
                <div class="tooltip-section">
                    <div class="tooltip-label">Hardware Vendor:</div>
                    <div class="tooltip-value">${d.vendor || getVendorFromGroup(d.group)}</div>
                </div>
                
                <div class="tooltip-section">
                    <div class="tooltip-label">Software/OS:</div>
                    <div class="tooltip-value">${d.os || d.firmware || 'N/A'}</div>
                </div>
            `;
            
            // Add VLAN information if available
            if (d.vlans && d.vlans.length > 0) {
                tooltipContent += `
                    <div class="vlan-info">
                        <div class="tooltip-label" style="margin-bottom: 6px;">VLAN Information:</div>
                        ${d.vlans.map(vlan => 
                            `<div class="vlan-item">• ${vlan.name} (${vlan.id})</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            // Add connection information
            const connections = getDeviceConnections(d);
            if (connections.length > 0) {
                tooltipContent += `
                    <div class="tooltip-section" style="margin-top: 12px;">
                        <div class="tooltip-label">Connections:</div>
                        <div class="tooltip-value">${connections.length} active connection(s)</div>
                    </div>
                `;
            }
            
            tooltip.innerHTML = tooltipContent;
        }
        
        function getDeviceTypeName(group) {
            const typeNames = {
                'internet': 'Internet Gateway',
                'fortigate': 'FortiGate Firewall',
                'appliance': 'Meraki MX Appliance',
                'switch': 'Meraki Switch',
                'wireless': 'Meraki Wireless AP',
                'fortiap': 'FortiAP Wireless',
                'client': 'Client Device',
                'unknown': 'Unknown Device'
            };
            return typeNames[group] || 'Unknown Device';
        }
        
        function getVendorFromGroup(group) {
            const vendors = {
                'internet': 'ISP',
                'fortigate': 'Fortinet',
                'appliance': 'Cisco Meraki',
                'switch': 'Cisco Meraki',
                'wireless': 'Cisco Meraki',
                'fortiap': 'Fortinet',
                'client': 'Various',
                'unknown': 'Unknown'
            };
            return vendors[group] || 'Unknown';
        }
        
        function getDeviceConnections(device) {
            return filteredLinks.filter(link => 
                link.source.id === device.id || link.target.id === device.id
            );
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function highlightNode(event, d) {
            // Reset all nodes and links
            node.classed('hidden', false);
            link.classed('hidden', false);
            nodeLabels.classed('hidden', false);

            // Find connected nodes
            const connectedNodes = new Set([d.id]);
            filteredLinks.forEach(link => {
                if (link.source.id === d.id) connectedNodes.add(link.target.id);
                if (link.target.id === d.id) connectedNodes.add(link.source.id);
            });

            // Highlight connected elements
            node.classed('hidden', n => !connectedNodes.has(n.id));
            nodeLabels.classed('hidden', n => !connectedNodes.has(n.id));
            link.classed('hidden', l => 
                !connectedNodes.has(l.source.id) || !connectedNodes.has(l.target.id));
        }

        function setupEventListeners() {
            // Layout change
            document.getElementById('layoutType').addEventListener('change', function() {
                currentLayout = this.value;
                updateSimulation();
            });

            // Device filter
            document.getElementById('deviceFilter').addEventListener('change', function() {
                const filterValue = this.value;
                
                if (filterValue === 'all') {
                    filteredNodes = [...allNodes];
                    filteredLinks = [...allLinks];
                } else {
                    filteredNodes = allNodes.filter(n => n.group === filterValue);
                    const nodeIds = new Set(filteredNodes.map(n => n.id));
                    filteredLinks = allLinks.filter(l => 
                        nodeIds.has(l.source.id || l.source) && 
                        nodeIds.has(l.target.id || l.target));
                }

                updateVisualization();
            });

            // Search functionality
            const searchInput = document.getElementById('search');
            const searchResults = document.getElementById('searchResults');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    searchResults.style.display = 'none';
                    // Reset highlighting
                    node.classed('hidden', false);
                    link.classed('hidden', false);
                    nodeLabels.classed('hidden', false);
                    return;
                }

                // Find matching nodes
                const matches = allNodes.filter(n => 
                    n.label.toLowerCase().includes(query) ||
                    (n.title && n.title.toLowerCase().includes(query))
                );

                // Show search results
                searchResults.innerHTML = '';
                if (matches.length > 0) {
                    matches.slice(0, 10).forEach(match => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'search-result';
                        resultDiv.textContent = match.label;
                        resultDiv.addEventListener('click', () => {
                            highlightNode(null, match);
                            searchInput.value = match.label;
                            searchResults.style.display = 'none';
                        });
                        searchResults.appendChild(resultDiv);
                    });
                    searchResults.style.display = 'block';
                } else {
                    searchResults.style.display = 'none';
                }
            });

            // Hide search results when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.search-box')) {
                    searchResults.style.display = 'none';
                }
            });
        }

        function updateVisualization() {
            // Update data binding
            link = link.data(filteredLinks);
            link.exit().remove();
            link = link.enter().append('line')
                .attr('class', 'link')
                .attr('stroke', d => connectionColors[d.type] || connectionColors.unknown)
                .attr('stroke-width', d => d.width || 4)
                .attr('stroke-opacity', 0.8)
                .attr('stroke-dasharray', d => d.dashes ? '8,4' : null)
                .merge(link);

            node = node.data(filteredNodes);
            node.exit().remove();
            node = node.enter().append('circle')
                .attr('class', 'node')
                .attr('r', d => {
                    // Larger icons for better visibility
                    if (d.group === 'fortigate') return 25;
                    if (d.group === 'appliance') return 22;
                    if (d.group === 'switch') return 20;
                    if (d.group === 'wireless' || d.group === 'fortiap') return 18;
                    return d.size || 16;
                })
                .attr('fill', d => deviceColors[d.group] || deviceColors.unknown)
                .attr('stroke', '#fff')
                .attr('stroke-width', 3)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', highlightNode)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .merge(node);

            nodeLabels = nodeLabels.data(filteredNodes);
            nodeLabels.exit().remove();
            nodeLabels = nodeLabels.enter().append('text')
                .attr('class', 'node-label')
                .text(d => d.label)
                .attr('dy', d => (d.size || 20) + 25)
                .merge(nodeLabels);

            updateSimulation();
        }

        function resetView() {
            // Reset filter
            document.getElementById('deviceFilter').value = 'all';
            document.getElementById('search').value = '';
            
            // Reset data
            filteredNodes = [...allNodes];
            filteredLinks = [...allLinks];
            
            // Reset highlighting
            node.classed('hidden', false);
            link.classed('hidden', false);
            nodeLabels.classed('hidden', false);
            
            // Reset zoom
            svg.transition().duration(750).call(
                d3.zoom().transform,
                d3.zoomIdentity
            );
            
            updateVisualization();
        }

        // Tab switching functionality
        function switchView(viewName) {
            // Update tab buttons
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update view content
            document.querySelectorAll('.view-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(viewName + '-view').classList.add('active');
            
            // If switching to inventory view, populate the table
            if (viewName === 'inventory') {
                populateInventoryTable();
            }
        }
        
        // Populate device inventory table with comprehensive data
        function populateInventoryTable() {
            const tableBody = document.getElementById('inventoryTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            allNodes.forEach(device => {
                const row = document.createElement('tr');
                
                // Status with indicator
                const statusCell = document.createElement('td');
                const statusClass = device.status === 'online' ? 'status-online' : 
                                  device.status === 'offline' ? 'status-offline' : 'status-warning';
                statusCell.innerHTML = `
                    <div class="status-indicator">
                        <span class="status-dot ${statusClass}"></span>
                        ${device.status || 'Unknown'}
                    </div>
                `;
                row.appendChild(statusCell);
                
                // Description/Name
                const nameCell = document.createElement('td');
                nameCell.textContent = device.name || device.label || 'Unknown';
                row.appendChild(nameCell);
                
                // Last Seen
                const lastSeenCell = document.createElement('td');
                lastSeenCell.textContent = device.last_seen || 'N/A';
                row.appendChild(lastSeenCell);
                
                // Device Type with badge
                const typeCell = document.createElement('td');
                const deviceTypeClass = `device-${device.group || 'unknown'}`;
                typeCell.innerHTML = `
                    <span class="device-type-badge ${deviceTypeClass}">
                        ${getDeviceTypeName(device.group)}
                    </span>
                `;
                row.appendChild(typeCell);
                
                // MAC Address
                const macCell = document.createElement('td');
                macCell.textContent = device.mac || 'N/A';
                row.appendChild(macCell);
                
                // IP Address
                const ipCell = document.createElement('td');
                ipCell.textContent = device.ip || device.address || 'N/A';
                row.appendChild(ipCell);
                
                // Connected To (Parent Device)
                const connectedCell = document.createElement('td');
                connectedCell.textContent = device.parent_device || 'N/A';
                row.appendChild(connectedCell);
                
                // VLAN Information
                const vlanCell = document.createElement('td');
                if (device.vlans && device.vlans.length > 0) {
                    const vlanBadges = device.vlans.map(vlan => 
                        `<span class="vlan-badge">${vlan.name || vlan.id}</span>`
                    ).join(' ');
                    vlanCell.innerHTML = vlanBadges;
                } else {
                    vlanCell.textContent = 'N/A';
                }
                row.appendChild(vlanCell);
                
                // Vendor
                const vendorCell = document.createElement('td');
                vendorCell.textContent = device.vendor || getVendorFromGroup(device.group);
                row.appendChild(vendorCell);
                
                // Model
                const modelCell = document.createElement('td');
                modelCell.textContent = device.model || 'N/A';
                row.appendChild(modelCell);
                
                // Firmware/OS
                const firmwareCell = document.createElement('td');
                firmwareCell.textContent = device.firmware || device.os || 'N/A';
                row.appendChild(firmwareCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // Filter inventory table based on search and filter criteria
        function filterInventoryTable() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const filterType = document.getElementById('inventoryFilter').value;
            const rows = document.querySelectorAll('#inventoryTableBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;
                
                const deviceName = cells[1].textContent.toLowerCase();
                const deviceType = cells[3].textContent.toLowerCase();
                const macAddress = cells[4].textContent.toLowerCase();
                const ipAddress = cells[5].textContent.toLowerCase();
                
                // Check search term match
                const matchesSearch = searchTerm === '' || 
                    deviceName.includes(searchTerm) ||
                    macAddress.includes(searchTerm) ||
                    ipAddress.includes(searchTerm);
                
                // Check filter type match
                const matchesFilter = filterType === 'all' || 
                    deviceType.includes(filterType.toLowerCase());
                
                // Show/hide row based on matches
                row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing enhanced network topology visualization...');
            loadTopologyData();
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            const width = window.innerWidth - 280;
            const height = window.innerHeight - 80;
            
            svg.attr('width', width).attr('height', height);
            
            if (simulation) {
                simulation.force('center', d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        });
    </script>
</body>
</html>
